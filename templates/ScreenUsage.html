{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% block content %}
    {% csrf_token %}

    <!-- 右侧内容 -->
    <!-- =============================================================================Card================ -->
    <div class="card h-100 d-flex flex-column">
        <!-- =========================================================================Card Header========= -->
        <div class="card-header">
            <div class="title_style">
                <span class="title_span_style">{{ title_name }}</span>
            </div>
            <div class="form_all border border-3 p-3 border_style">
                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "Screen" %}:</label>
                        <label for="id_sn"></label><input type="text" id="id_sn" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "ConsumableType" %}:</label>
                        <label for="id_ConsumableType"></label><input type="text" id="id_ConsumableType" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "Model" %}:</label>
                        <label for="id_model"></label><input type="text" id="id_model" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "VersionType" %}:</label>
                        <label for="id_version"></label><input type="text" id="id_version" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "ToolType" %}:</label>
                        <label for="id_tooltype"></label><input type="text" id="id_tooltype" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "Status" %}:</label>
                        <label for="id_status"></label><input type="text" id="id_status" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "RatedLife" %}:</label>
                        <label for="id_ratedlife"></label><input type="text" id="id_ratedlife" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "RemainingLife" %}:</label>
                        <label for="id_remaininglife"></label><input type="text" id="id_remaininglife" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "UseTime" %}:</label>
                        <label for="id_usetime"></label><input type="date" id="id_usetime" class="form-control my-input">
                    </div>
                    <!--
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "No EmulsionShedding" %}:</label>
                        <label for="id_no_ES"></label><input type="text" id="id_no_ES" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "No MeshPlugging" %}:</label>
                        <label for="id_no_MP"></label><input type="text" id="id_no_MP" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "CheckOperator" %}:</label>
                        <label for="id_checkoperator"></label><input type="text" id="id_checkoperator" class="form-control my-input">
                    </div>
                    -->
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "PrintingNumber" %}:</label>
                        <label for="id_PrintingNumber"></label><input type="text" id="id_PrintingNumber" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "Print_Operator" %}:</label>
                        <label for="id_Print_Operator"></label><input type="text" id="id_Print_Operator" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "AddUpPrint" %}:</label>
                        <label for="id_AddUpPrint"></label><input type="text" id="id_AddUpPrint" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "Add_Operator" %}:</label>
                        <label for="id_Add_Operator"></label><input type="text" id="id_Add_Operator" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">{% trans "Clean" %}:</label>
                        <label for="id_Clean"></label>
                        <select id="id_Clean" class="form-select my-input">
                            <option selected value="Y">{% trans "Y" %}</option>
                            <option value="N">{% trans "N" %}</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "Clean_Operator" %}:</label>
                        <label for="id_Clean_Operator"></label><input type="text" id="id_Clean_Operator" class="form-control my-input">
                    </div>
                    <!--
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "Position" %}:</label>
                        <label for="id_position"></label><input type="text" id="id_position" class="form-control my-input">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label my-label">{% trans "Comment" %}:</label>
                        <label for="id_comment"></label><input type="text" id="id_comment" class="form-control my-input">
                    </div>
                    -->
                </div>
                <div class="row mt-2">
                    <div class="col-md-12 d-flex justify-content-end align-items-center">
                        <!-- 触发模态框的按钮 -->
                        <button type="button" class="btn btn-primary button_style rot-135" onclick="openModal()">{% trans "Spot Check" %}</button>
                        <button id="id_show" type="submit" class="btn btn-secondary me-2 button_style rot-135">{% trans "Show" %}</button>
                        <button id="id_ok" type="submit" class="btn btn-primary button_style rot-135">{% trans "Submit" %}</button>
                    </div>
                </div>
            </div>

        </div>
        <!-- =========================================================================Card Body=========== -->
        <div class="card-body flex-grow-8">
            <div class="modal" tabindex="-1" role="dialog" id="myModal" style="max-height: 1600px !important;">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title">{% trans "Spot Check Info" %}</h1>
                            <div class="col-md-2">
                                <label class="form-label my-label">{% trans "CheckTime" %}:</label>
                                <label for="CheckTime"></label><input type="datetime-local" id="CheckTime" class="form-control">
                            </div>
                            <button type="button" onclick="closeModal()">
                                <span aria-hidden="true"><i class="fa fa-window-close"></i></span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- 将表单字段包装在一个类为“table”的 div 容器中 -->
                            <div class="table-responsive border border-3 p-3 border_style table-with-title">
                                <table id="myTable" class="display table table-striped table-bordered table-switch">
                                    <thead style="table-layout: auto;">
                                    <tr>
                                        {% for i in modal_headList %}
                                            <th>{{ i }}</th>
                                        {% endfor %}
                                    </tr>
                                    </thead>
                                    <tbody id="modal_tbody">
                                    <tr>
                                        {% for i in '000000000000000' %}
                                            <td>
                                                <label>
                                                    <input type="text" class="form-control" value="0" style="width: 100%">
                                                </label>
                                            </td>
                                        {% endfor %}
                                        <td>
                                            <label class="switch-cell switch" for="checkbox1">
                                                <input type="checkbox" id="checkbox1" checked="checked" value="true" onchange="updateSwitch('checkbox1')"/>
                                                <div class="slider"></div>
                                            </label>
                                        </td>
                                        <td>
                                            <label class="switch-cell switch" for="checkbox2">
                                                <input type="checkbox" id="checkbox2" checked="checked" value="true" onchange="updateSwitch('checkbox2')"/>
                                                <div class="slider"></div>
                                            </label>
                                        </td>
                                        <td>
                                            <label>
                                                <input type="text" id="CheckOperator" class="form-control">
                                            </label>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">{% trans "Close" %}</button>
                            <button type="button" class="btn btn-primary" onclick="saveModal()">{% trans "Save" %}</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-responsive border border-3 p-3 border_style table-with-title">
                <h1>{% trans "Screen UsageInfo" %}</h1>
                <table id="usehistory_dt" class="table table-striped table-bordered">
                    <thead>
                    <tr>
                        {% for i in head_list %}
                            <th>{{ i }}</th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody id="usehistory_dt_tbody">
                    </tbody>
                </table>
            </div>

        </div>
        <!-- =========================================================================Card Footer========= -->
        <div class="card-footer">
        </div>
    </div>

    <script>
        // 初始化 DataTables
        $("#myTable").DataTable(modal_dt);

        function updateSwitch(id) {
            const switchValue = document.getElementById(id).checked;

            // 根据开关的状态执行其他操作
            if (switchValue) {
                $('#' + id).val(switchValue)
                // 其他操作
            } else {
                $('#' + id).val(switchValue)
            }
        }


        function openModal() {
            const now = new Date();
            const formattedDateTime = now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate() + 'T' + now.getHours() + ':' + now.getMinutes();
            // 将当前时间转换为ISO 8601格式的字符串
            // 将格式化后的字符串设置为datetime-local元素的值
            const utcTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
            document.getElementById('CheckTime').value = utcTime.toISOString().slice(0, 16).replace('T', ' ') + formattedDateTime.slice(-3);

            // 获取输入框的值
            const sn = document.getElementById('id_sn').value;
            const status = document.getElementById('id_status').value;
            if (sn && status === 'Using' || status === '使用中') {
                // 将 sn 值传递给模态框
                $('#myModal').data('sn', sn);
                // 获取模态框
                const myModal = document.getElementById("myModal");
                // 显示模态框
                $(myModal).modal("show");
            } else {
                myAlert("請輸入網板編號並檢查網板是否正在使用中再進行點點檢！", 'danger')
            }
        }

        function closeModal() {
            // 获取模态框
            const myModal = document.getElementById("myModal");
            // 显示模态框
            $(myModal).modal("hide");
        }

        function saveModal() {
            // 在此处添加保存模态框内容的逻辑
            // 获取模态框父窗口中的输入框值
            const sn = $('#myModal').data('sn');
            let CheckTime = $("#CheckTime").val()
            let list = getModalFormData("myTable")
            // list[0][17]取得的是最后一个数据的值
            if (list[0][17] && CheckTime && sn) {
                $.ajax({
                    type: 'POST',
                    url: '/CMS/ScreenCheck/',
                    data: {
                        'sn': sn,
                        'CheckTime': CheckTime,
                        'list': JSON.stringify(list[0]),
                    },
                    success: function (reply) {
                        myAlert(reply.msg, reply.type)
                    }
                })
            } else {
                myAlert("所有欄位不能爲空！", 'danger')
            }
            // 重置表单为默认值
            const myTable = document.getElementById("myTable");
            myTable.querySelectorAll("input[type='text']").forEach(function (input) {
                input.value = "0";
            });
            myTable.querySelectorAll("input[type='checkbox']").forEach(function (checkbox) {
                checkbox.checked = true;
            });
            myTable.querySelector("#CheckOperator").value = "";

            // 获取模态框
            const myModal = document.getElementById("myModal");
            // 隐藏模态框
            $(myModal).modal("hide");
        }

        $(document).ready(function () {
            myAlert("提示：確認輸入網板編號后,請先點擊顯示按鈕進行查詢使用記錄再點檢使用！")
            const readonly_list = ['id_ConsumableType', 'id_model', 'id_version', 'id_tooltype', 'id_status',
                'id_ratedlife', 'id_remaininglife', 'id_AddUpPrint'];
            const usehistory_dt = $("#usehistory_dt").DataTable(checkbox_dt);
            let queryString = window.location.search
            if (queryString !== '') {
                const urlParams = new URLSearchParams(queryString);
                const sn = urlParams.get('id_sn')
                const ConsumableType = urlParams.get('id_ConsumableType')
                const model = urlParams.get('id_model')
                const version = urlParams.get('id_version')
                const tooltype = urlParams.get('id_tooltype')
                const ratedlife = urlParams.get('id_ratedlife')
                const usefullife = urlParams.get('id_usefullife')
                const status = urlParams.get('id_status')
                const remaininglife = parseInt(ratedlife) - parseInt(usefullife)
                const input_list = [ConsumableType, model, version, tooltype, status, ratedlife, remaininglife, usefullife]
                set_input_values(input_list, readonly_list)
                set_attr_readonly(readonly_list)
                $("#id_sn").val(sn)
            } else {
                const sn = $("#id_sn").val()
                const AddUpPrint = $("#id_AddUpPrint").val()
                const ConsumableType = $("#id_ConsumableType").val()
                const model = $("#id_model").val()
                const version = $("#id_version").val()
                const tooltype = $("#id_tooltype").val()
                const ratedlife = $("#id_ratedlife").val()
                const status = $("#id_status").val()
                const remaininglife = $("#id_remaininglife").val()
                const input_list = [ConsumableType, model, version, tooltype, status, ratedlife, remaininglife, AddUpPrint]
                $("#id_sn").val(sn)
                set_input_values(input_list, readonly_list)
                set_attr_readonly(readonly_list)
            }


            function show() {
                let sn = $("#id_sn").val()
                if (sn !== '') {
                    $.ajax({
                        type: 'POST',
                        url: '/CMS/ScreenUsageInfo/',
                        data: {
                            'sn': sn,
                        },
                        success: function (reply) {
                            if (reply.type === 'success') {
                                let data = reply.data
                                let input_list = data['input_list']
                                let usehistory_list = data['usehistory_list']
                                list_to_dt_data_checkbox0(usehistory_dt, usehistory_list, 'clear')
                                set_input_values(input_list, readonly_list)
                            } else {
                                myAlert(reply.msg, reply.type)
                            }
                        }
                    })
                } else {
                    myAlert("提示：請輸入網板編號！", 'danger')
                }
            }

            $("#id_show").click(function () {
                show();
            })

            $("#id_sn").keydown(function (e) {
                if (e.keyCode === 13) {
                    show();
                }
            })

            function submit() {
                let screen_list = get_table_rows_data_chosen('usehistory_dt_tbody')
                let sn = $("#id_sn").val()
                let usetime = $("#id_usetime").val()
                let PrintingNumber = $("#id_PrintingNumber").val()
                let Print_Operator = $("#id_Print_Operator").val()
                let Add_Operator = $("#id_Add_Operator").val()
                let Clean = $("#id_Clean").val()
                let Clean_Operator = $("#id_Clean_Operator").val()
                let status = $("#id_status").val()
                let data_list = [sn, usetime, PrintingNumber, Print_Operator, Add_Operator, Clean, Clean_Operator]
                if (sn !== '' && usetime !== '' && PrintingNumber !== '' && Print_Operator !== '' && Add_Operator !== '' && Clean_Operator !== '') {
                    if (status === 'Using' || status === '使用中') {
                        if (screen_list && screen_list.length === 1 && screen_list[0][24] === '') {
                            $.ajax({
                                type: 'POST',
                                url: '',
                                data: {
                                    'screen_list': JSON.stringify(screen_list),
                                    'data_list': JSON.stringify(data_list),
                                },
                                success: function (reply) {
                                    if (reply.type === 'success') {
                                        let data = reply.data
                                        let usehistory_list = data['usehistory_list']
                                        let remaininglife = data['remaininglife']
                                        let AddUpPrint = data['AddUpPrint']
                                        let status = data['status']
                                        $("#id_remaininglife").val(remaininglife)
                                        $("#id_AddUpPrint").val(AddUpPrint)
                                        $("#id_status").val(status)
                                        list_to_dt_data_checkbox0(usehistory_dt, usehistory_list, 'clear')
                                    }
                                    set_val_empty(["id_usetime", "id_PrintingNumber", "id_Print_Operator", "id_Add_Operator", "id_Clean_Operator"])
                                    myAlert(reply.msg, reply.type)
                                }
                            })
                        } else {
                            myAlert("請選取一條未添加使用的數據進行添加使用記錄！", 'danger')
                        }
                    } else {
                        myAlert("提示：網板狀態不爲使用中！", 'danger')
                    }
                } else {
                    myAlert("提示：都是必填欄位哦!", 'danger')
                }

            }

            $("#id_ok").click(function () {
                submit();
            })
        })
    </script>
{% endblock %}